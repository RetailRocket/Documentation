# Получение рекомендаций в мобильном приложении

## **Общие концепции**

Параметры `productIds`, `categoryIds`, `stockId` должны совпадать с аналогичными параметрами передаваемыми в YML-файле.

Товарные рекомендации запрашиваются по протоколу HTTP методом GET и возвращают ответ в формате json. Ответ имеет вид массива объектов Recommendation. 

В случае запроса рекомендаций к несуществующему товару, ответ будет иметь вид пустого массива.

В ответах API содержится заголовок Cache-Control которому необходимо следовать при кэшировании ответов.

#### **Управление сессией**

* Для управления сессией используется параметр `sessionExternalId`. Для API он передается в качестве query параметра, для трекинга в теле запроса.
* Это произвольная строка длиной до 50 символов
* `sessionExternalId` может быть любым, но уникальным для каждой установки мобильного приложения
* не рекомендуется использовать любые персональные данные пользователя \(например email\). Вместо этого лучше сгенерировать случайный guid при первом запуске приложения и использовать его во всех последующих запросах

#### **Авторизация**

* Для авторизации необходимо во все запросы включать query параметр apiKey={apiKey}
* apiKey может измениться, это нужно учитывать при разработки интеграции, и хранить его в БД на сервере
* apiKey можно получить у аккаунт-менеджера
* В случае неуспешной авторизации \(неверный apiKey\) вернется статус 401

#### **Лимиты**

API может возвращать HTTP Status 429 TooManyRequests, если система зафиксирует высокую частоту запросов.

Лимит по умолчанию 100 RPS \(запросов в секунду\) на каждый `partnerId`. Для изменения лимита необходимо обратиться к вашему аккаунт-менеджеру.

**Протокол**

HTTP

**Метод**

GET

**Response**

Формат ответа: JSON

```markup
{
    "recommendations":
    [
        {
            "productId": <item id>, // number, id of product
        }
    ]
}
```

На любой корректно сформированный запрос будет ответ HTTP 200

Если рекомендаций по этим параметром нет -- мы вернем пустой ответ:

```markup
{
    "recommendations": []
}
```

**Response Statuses**

* 200 OK - запрос принят
* 400 BadRequest - ошибка в запросе, необходимо проверить правильность построения запроса
* 401 Unauthorized - ошибка аутентификации, проверьте корректность пары partnerId, ApiKey
* 403 Forbidden - доступ запрещен
* 404 NotFound - запрошенный ресурс не найден, необходимо проверить правильность URL
* 429 TooManyRequest - слишком много запросов и/или лимит на количество запросов в интервал времени превышен

**base url**

{% embed url="https://externalapi.retailrocket.net/api/3.0" %}

## **Подробное описание методов получения рекомендаций**

### **Персональные рекомендации**

Алгоритм персональных рекомендаций возвращает наиболее интересные товары для пользователя

**path**

/partnerRecommendations/personalComposite/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey

### **Сопутствующие товары**

Алгоритм возвращает сопутствующие товарные позиции, которые с максимальной вероятностью могут быть куплены вместе с товаром, к которому запрошены рекомендации.

**path**

/productRecommendations/related/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

### **Сопутствующие товары, персонализированные с учетом интереса пользователя по свойствам**

Алгоритм возвращает сопутствующие товарные позиции, подобранные с учетом интереса пользователя к параметрам товаров, если они передаются в товарной базе магазина в платформу Retail Rocket.

**path**

/productRecommendations/relatedByInterestedProperties/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

### **Аксессуары**

Алгоритм возвращает сопутствующие товарные позиции из числа аксессуаров, которые с максимальной вероятностью могут быть куплены вместе с товаром, который пользователь просматривает или который содержится в его корзине.

**path**

/productRecommendations/accessories/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

### **Альтернативные товары**

Алгоритм возвращает похожие товарные позиции, которые заинтересуют пользователя, взаимодействующего с товаром, переданным на вход, с максимальной вероятностью.

**path**

/productRecommendations/alternatives/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

### **Популярные товары для главного экрана**

Популярные товары для главного экрана Алгоритм возвращает популярные товары магазина.

**path**

**/**partnerRecommendations/popular/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey

### **Популярные товары для экрана категорий**

Алгоритм возвращает популярные товары в категории.

**path**

/categoryRecommendations/popular/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* categoryIds // id of categories, categoryIds=categoryId1,categoryId2

### **Поисковые рекомендации**

Система Retail Rocket предоставляет рекомендации на основе ключевых слов, которые пользователи запрашивают во внутреннем поиске по сайту интернет-магазина. Поисковые рекомендации следует применять на странице результатов внутреннего поиска.

**path**

/searchRecommendations/search/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* searchPhrase - поисковый запрос пользователя



### **VisitorInterest**

Retail Rocket в реальном времени анализирует интересы пользователя и строит связи «пользователь» – «категория». Это позволяет демонстрировать хиты продаж только из категорий, которые наиболее интересны данному пользователю в долгосрочной перспективе.

**path**

/partnerRecommendations/popularInInterestedCategories/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey

### **Сопутствующие товары из категорий, отличных от категории текущего товара**

Из рекомендаций сопутствующих товаров удаляются товары, принадлежащие той же категории, что и текущий товар.

**path**

productRecommendations/relatedWithoutCurrentCategory/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

### **Сопутствующие товары с учетом бизнес-правил**

Пользователю предлагаются товары, которыми он может дополнить заказ. Выдача строится на истории взаимодействий пользователей с товарной базой магазина и учитывает изменения совместного спроса. Отличный инструмент для увеличения среднего чека интернет-магазина.

**path**

productRecommendations/relatedWithRules/

**method**

GET

**query**

* sessionExternalId
* stockId
* partnerId
* apiKey
* productIds // id of products, productIds=productId1,productId2

## **Полный перечень доступных алгоритмов рекомендаций**

Инструкции по каждому из запросов предоставляются индивидуально “по запросу”.

### **Алгоритмы, выдача которых может быть кэширована**

1. Популярные товары/Хиты продаж
2. Хиты продаж определенного бренда
3. Новинки
4. Хиты продаж, на которые есть скидка
5. Новинки, на которые есть скидка
6. Похожие товары
7. Сопутствующие товары
8. Сопутствующие товары с приоритетом товаров того же вендора, что и просматриваемый товар
9. Сопутствующие товары с уменьшением веса популярных товаров в выдаче
10. Сопутствующие товары отфильтрованные на основе опросов пользователей
11. Сопутствующие товары из категорий, отличных от категории текущего товара
12. Аксессуары

### **Алгоритмы, которые работают в реальном времени, выдача которых не может быть кэширована**

1. Популярные товары из категорий, интересных пользователю
2. Персональные рекомендации для главной страницы
3. Персональные рекомендации для страницы категории
4. Ранее просмотренные пользователем товары
5. Ранее купленные пользователем товары
6. Новинки из категорий, интересных пользователю
7. Хиты продаж из категорий, интересных пользователю, на которые есть скидка
8. Новинки из категорий, интересных пользователю, на которые есть скидка
9. Похожие товары с акцентом на просмотренных пользователем товарах
10. Похожие товары с учётом размеров
11. Похожие товары, оптимизированные по RPV
12. Поисковые рекомендации
13. Поисковые рекомендации с уменьшением веса популярных товаров в выдаче
14. Персонализация рекомендаций с учетом интереса пользователя к свойствам товаров

### **Создание бесконечной выдачи рекомендаций**

Для создания “бесконечной” выдачи рекомендаций сначала необходимо запросить рекомендации популярных по магазину товаров \(хитов, интересных пользователю\):

**`https://externalapi.retailrocket.net/api/3.0/partnerRecommendations/popularInInterestedCategories/?﻿sessionExternalId=<sessionId>&partnerId=<partnerId>&apiKey=<apiKey>`**

Полученный объект с массивом объектов необходимо распарсить и получить у каждого ключа productId его значение \(id товара\), поочередно с нулевого элемента подставив в каждый из следующих запросов на место &lt;productIds&gt;:

`https://externalapi.retailrocket.net/api/3.0/productRecommendations/alternatives/?﻿sessionExternalId=<sessionId>&partnerId=<partnerId>&apiKey=<apiKey>&productIds=<productIds>  
  
https://externalapi.retailrocket.net/api/3.0/productRecommendations/related/?﻿sessionExternalId=<sessionId>&partnerId=<partnerId>&apiKey=<apiKey>&productIds=<productIds>  
  
https://externalapi.retailrocket.net/api/3.0/productRecommendations/accessories/?﻿sessionExternalId=<sessionId>&partnerId=<partnerId>&apiKey=<apiKey>&productIds=<productIds>`

После использования всех товаров из первого запроса необходимо распарсить результаты каждого из трех запросов выше, взять первый товар из выдачи alternatives и запросить для него alternatives, первый товар из related и запросить для него related, первый товар из accessories и запросить для него accessories, и так далее.  
****  


